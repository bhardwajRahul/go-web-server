# Security Guide

Comprehensive security implementation for the Modern Go Stack.

## Security Architecture

Defense-in-depth approach with multiple protection layers:

1. **Input Sanitization** - XSS and SQL injection prevention
2. **CSRF Protection** - Cross-site request forgery prevention
3. **Security Headers** - Browser security controls
4. **Rate Limiting** - DoS and abuse prevention
5. **Error Handling** - Information disclosure prevention
6. **Request Tracing** - Security monitoring

## CSRF Protection

### Implementation

Custom CSRF middleware in `internal/middleware/csrf.go` protects all state-changing operations.

**Configuration:**

```go
CSRFConfig{
    TokenLength:    32,
    TokenLookup:    "header:X-CSRF-Token,form:csrf_token",
    CookieName:     "_csrf",
    CookieHTTPOnly: true,
    CookieSameSite: http.SameSiteStrictMode,
    CookieMaxAge:   86400,  // 24 hours
}
```

**Usage in forms:**

```html
<form method="POST" action="/users">
  <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
  <!-- form fields -->
</form>
```

**Usage in HTMX:**

```html
<button hx-post="/users" hx-headers='{"X-CSRF-Token": "{{.CSRFToken}}"}'>
  Submit
</button>
```

### Security Features

- Constant-time comparison (prevents timing attacks)
- Token rotation on each request
- Cryptographically secure tokens (`crypto/rand`)
- Multiple extraction sources (header, form, query)

## Input Sanitization

### Automatic Protection

All user input sanitized via `internal/middleware/sanitize.go`:

**HTML Sanitization:**

```go
input = html.EscapeString(input)
```

**XSS Protection:**

- Removes dangerous patterns: `javascript:`, `<script>`, `onload=`
- Blocks data URLs and blob URLs

**SQL Injection Prevention:**

- Removes SQL comments: `--`, `/*`, `*/`
- Blocks dangerous patterns: `union select`, `drop table`

## Security Headers

### Applied Headers

```go
// Echo's SecureMiddleware
XSSProtection:         "1; mode=block"
ContentTypeNosniff:    "nosniff"
XFrameOptions:         "DENY"
HSTSMaxAge:            31536000    // 1 year
ContentSecurityPolicy: "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'"

// Additional custom headers
"Referrer-Policy": "strict-origin-when-cross-origin"
"Permissions-Policy": "geolocation=(), microphone=(), camera=()"
```

### Content Security Policy

**Current (HTMX Compatible):**

```
default-src 'self';
style-src 'self' 'unsafe-inline';    # Required for Pico.css
script-src 'self' 'unsafe-inline'    # Required for HTMX
```

**Stricter Production CSP:**

```
default-src 'self';
style-src 'self';
script-src 'self';
object-src 'none';
frame-ancestors 'none';
```

## Rate Limiting

### Default Configuration

```go
RateLimiterConfig{
    Store: echomiddleware.NewRateLimiterMemoryStore(20),  // 20 req/min
    IdentifierExtractor: func(c echo.Context) (string, error) {
        return c.RealIP(), nil  // Rate limit by IP
    },
}
```

## Error Handling Security

### Information Disclosure Prevention

Structured error handling prevents sensitive information leakage:

```go
// Production - sanitized errors
if cfg.App.Environment == "production" {
    if code >= 500 {
        errorResp.Message = "Internal server error"
        errorResp.Details = nil
    }
}
```

### Error Types

```go
const (
    ErrorTypeValidation    ErrorType = "validation"
    ErrorTypeNotFound      ErrorType = "not_found"
    ErrorTypeInternal      ErrorType = "internal"
    ErrorTypeCSRF          ErrorType = "csrf"
    ErrorTypeRateLimit     ErrorType = "rate_limit"
)
```

## Database Security

### Query Security (SQLC)

All queries use parameterized statements generated by SQLC:

```sql
-- queries.sql - Always parameterized
-- name: GetUserByEmail :one
SELECT * FROM users WHERE email = $1 LIMIT 1;
```

Generated Go code prevents SQL injection:

```go
user, err := h.store.GetUserByEmail(ctx, email)
```

### Database Connection Security

PostgreSQL connection security:

```bash
# Secure connection strings
DATABASE_URL="postgres://user:password@localhost:5432/gowebserver?sslmode=require"

# Connection pooling limits
DATABASE_MAX_CONNECTIONS=25
DATABASE_MIN_CONNECTIONS=5
```

## Cookie Security

### Secure Settings

```go
cookie := &http.Cookie{
    Name:     "session",
    HttpOnly: true,                            // Prevent XSS access
    Secure:   cfg.App.Environment == "production",  // HTTPS only
    SameSite: http.SameSiteStrictMode,         // CSRF protection
}
```

## Security Monitoring

### Request Tracing

Every request gets unique ID for security monitoring:

```go
slog.Warn("security event",
    "event_type", "csrf_failure",
    "request_id", c.Response().Header().Get(echo.HeaderXRequestID),
    "remote_ip", c.RealIP(),
    "user_agent", c.Request().UserAgent())
```

### Security Events

- CSRF token validation failures
- Rate limit hits
- Suspicious input patterns
- Authentication failures

## Production Security Checklist

### Environment

- [ ] `APP_ENVIRONMENT="production"` set
- [ ] Debug mode disabled (`APP_DEBUG="false"`)
- [ ] CORS configured with specific origins
- [ ] HTTPS enforced with HSTS headers
- [ ] Secure cookie settings enabled

### File System

- [ ] Database file permissions restricted (`chmod 600`)
- [ ] Application runs as non-root user
- [ ] Directory permissions properly set

### Monitoring

- [ ] Security logging enabled
- [ ] Request tracing configured
- [ ] Security metrics monitored
- [ ] Regular security scans scheduled

This security implementation provides comprehensive protection while maintaining the performance and simplicity of the Modern Go Stack.
